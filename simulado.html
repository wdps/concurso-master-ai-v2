<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado - ConcursoMaster AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --info-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --dark-text: #333;
            --light-text: #6c757d;
            --card-bg: #ffffff;
            --body-bg: #f5f7ff;
            --header-bg: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            --progress-bg: #e9ecef;
            --border-radius: 12px;
            --box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --primary-color: #4895ef;
            --secondary-color: #4361ee;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --info-color: #3a0ca3;
            --light-color: #343a40;
            --dark-color: #f8f9fa;
            --dark-text: #e9ecef;
            --light-text: #adb5bd;
            --card-bg: #2d3748;
            --body-bg: #1a202c;
            --header-bg: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            --progress-bg: #4a5568;
            --box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        body {
            background-color: var(--body-bg);
            color: var(--dark-text);
            transition: var(--transition);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: var(--header-bg) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        /* Tema escuro/claro */
        .theme-toggle {
            background: transparent;
            border: none;
            color: var(--light-color);
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            transform: rotate(30deg);
        }

        /* Configuração do Simulado - Estilo Gameficado */
        .page-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-bg);
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            background: var(--header-bg);
            color: white;
            border-bottom: none;
            padding: 1.25rem 1.5rem;
            font-weight: 600;
        }

        .card-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
        }

        .card-header h5 i {
            margin-right: 0.5rem;
        }

        /* Matérias - Estilo de Cards Interativos */
        .materia-card {
            border: 2px solid transparent;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            background-color: var(--card-bg);
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .materia-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
        }

        .materia-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }

        .materia-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .materia-checkbox {
            display: none;
        }

        .materia-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Sliders Estilizados */
        .form-range {
            height: 8px;
            border-radius: 5px;
        }

        .form-range::-webkit-slider-thumb {
            background-color: var(--primary-color);
            border: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .form-range::-moz-range-thumb {
            background-color: var(--primary-color);
            border: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .config-value {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            display: inline-block;
        }

        /* Botões Gameficados */
        .btn-primary {
            background: var(--primary-color);
            border: none;
            border-radius: 50px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.4);
            background: var(--secondary-color);
        }

        .btn-lg {
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
        }

        .btn-outline-secondary {
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
        }

        /* Tela do Simulado - Design Gameficado */
        #tela-simulado {
            padding-top: 100px;
        }

        .questao-header {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .questao-counter {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .materia-badge-small {
            background-color: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .timer-container {
            background: var(--header-bg);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .timer-container.warning {
            background: linear-gradient(135deg, #f8961e 0%, #f3722c 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .progress {
            height: 12px;
            border-radius: 10px;
            background-color: var(--progress-bg);
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--success-color) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Questão e Alternativas - Design Gameficado */
        #questao-enunciado {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            font-size: 1.15rem;
            line-height: 1.7;
            color: var(--dark-text);
            margin-bottom: 1.5rem;
            box-shadow: var(--box-shadow);
            position: relative;
        }

        #questao-enunciado:before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary-color);
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }

        .alternativa {
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: var(--transition);
            background-color: var(--card-bg);
            font-size: 1.05rem;
            color: var(--dark-text);
            text-align: left;
            padding: 1.2rem;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .alternativa:before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .alternativa:hover:not(:disabled):before {
            left: 100%;
        }

        .alternativa:hover:not(:disabled) {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .alternativa.selecionada {
            border-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
            font-weight: 600;
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.2);
        }

        .alternativa.correta {
            border-color: var(--success-color) !important;
            background-color: rgba(76, 201, 240, 0.15) !important;
            color: var(--success-color) !important;
            font-weight: 600;
        }

        .alternativa.errada-escolhida {
            border-color: var(--danger-color) !important;
            background-color: rgba(247, 37, 133, 0.1) !important;
            color: var(--danger-color) !important;
            font-weight: normal;
        }

        .alternativa:disabled {
            cursor: not-allowed;
            opacity: 0.9;
        }

        .alternativa strong {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #e9ecef;
            color: var(--dark-text);
            font-weight: bold;
            margin-right: 15px;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .alternativa.selecionada strong {
            background-color: var(--primary-color);
            color: #fff;
        }

        .alternativa.correta strong {
            background-color: var(--success-color);
            color: #fff;
        }

        .alternativa.errada-escolhida strong {
            background-color: var(--danger-color);
            color: #fff;
        }

        /* Feedback Box - Design Gameficado */
        .feedback-box {
            margin-top: 1.5rem;
            border-radius: var(--border-radius);
            animation: fadeIn 0.5s ease;
            overflow: hidden;
            border: none;
            box-shadow: var(--box-shadow);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feedback-box .nav-tabs {
            border-bottom: none;
            background-color: var(--light-color);
            padding: 0.5rem;
        }

        .feedback-box .nav-tabs .nav-link {
            border: none;
            border-radius: 8px;
            color: var(--light-text);
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            margin: 0 0.25rem;
            transition: var(--transition);
        }

        .feedback-box .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        .feedback-box.correto #feedback-titulo-container {
            background: linear-gradient(135deg, var(--success-color) 0%, #38b000 100%);
            color: white;
            padding: 1.25rem 1.5rem;
        }

        .feedback-box.incorreto #feedback-titulo-container {
            background: linear-gradient(135deg, var(--danger-color) 0%, #b5179e 100%);
            color: white;
            padding: 1.25rem 1.5rem;
        }

        .feedback-box .tab-content {
            padding: 1.5rem;
            background-color: var(--card-bg);
        }

        .dica-box, .formula-box {
            border-left: 5px solid var(--warning-color);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: var(--dark-text);
            font-size: 0.95rem;
            background-color: rgba(248, 150, 30, 0.1);
        }

        .formula-box {
            border-left-color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }

        /* Sistema de Conquistas e Pontuação */
        .achievement-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, var(--warning-color) 0%, #f3722c 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            margin: 0.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            animation: bounceIn 0.6s;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .xp-bar {
            height: 8px;
            background-color: var(--progress-bg);
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .xp-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color) 0%, #38b000 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Modal de Resultado - Design Gameficado */
        .modal-content {
            border: none;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .modal-header {
            background: var(--header-bg);
            color: white;
            border-bottom: none;
            padding: 1.5rem 2rem;
        }

        .stats-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            height: 100%;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-card h3 {
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--primary-color);
        }

        .performance-chart {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
        }

        .recomendation-item {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .recomendation-item:hover {
            transform: translateX(5px);
        }

        /* Animações e Efeitos Especiais */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--primary-color);
            opacity: 0;
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(67,97,238,0.1) 0%, transparent 70%);
            z-index: 999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .questao-header {
                padding: 1rem;
            }
            
            #questao-enunciado {
                padding: 1.5rem;
            }
            
            .alternativa {
                padding: 1rem;
            }
            
            .timer-container {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }
        }
    </style>
</head>
<body class="bg-light">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-brain me-2"></i><strong>Concurso</strong>Master AI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Início</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/simulado">Simulado</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/redacao">Redação</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link theme-toggle" id="theme-toggle">
                            <i class="fas fa-moon"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- Tela de Configuração -->
        <div id="tela-configuracao" class="page-container">
            <div class="text-center mb-4">
                <div class="position-relative d-inline-block">
                    <i class="fas fa-cogs fa-3x text-primary"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        NOVO
                    </span>
                </div>
                <h1 class="h2 mt-2">Configurar Simulado</h1>
                <p class="lead text-muted">Personalize seu simulado para maximizar seu aprendizado.</p>
                
                <!-- Barra de XP -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <small class="text-muted">Nível 5</small>
                    <small class="text-muted">Próximo nível: 200 XP</small>
                </div>
                <div class="xp-bar mx-auto" style="max-width: 300px;">
                    <div class="xp-progress" style="width: 65%;"></div>
                </div>
            </div>

            <!-- Seleção de Matérias -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-book me-2 text-primary"></i>1. Selecione as Matérias</h5>
                </div>
                <div class="card-body">
                    <div id="lista-materias" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-2">
                        <!-- Conteúdo dinâmico das matérias -->
                        <div class="col-12 text-center p-5">
                             <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="text-muted mt-2">Carregando matérias...</p>
                        </div>
                    </div>
                     <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="selecionar-todas">
                        <label class="form-check-label" for="selecionar-todas">
                            Selecionar Todas / Nenhuma
                        </label>
                    </div>
                </div>
            </div>

            <!-- Configurações (Sliders) -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-sliders-h me-2 text-primary"></i>2. Ajustes</h5>
                </div>
                <div class="card-body">
                    <div class="row config-sliders">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <label for="quantidade-questoes" class="form-label">
                                Quantidade de Questões: <span id="quantidade-value" class="config-value">50</span>
                            </label>
                            <input type="range" class="form-range" id="quantidade-questoes" min="5" max="100" value="50" step="5">
                        </div>
                        <div class="col-md-6">
                            <label for="tempo-simulado" class="form-label">
                                Tempo Limite: <span id="tempo-value" class="config-value">180</span> minutos
                            </label>
                            <input type="range" class="form-range" id="tempo-simulado" min="15" max="360" value="180" step="15">
                        </div>
                    </div>
                    <div class="form-check form-switch fs-6 mt-3">
                        <input class="form-check-input" type="checkbox" id="modo-aleatorio" checked>
                        <label class="form-check-label" for="modo-aleatorio">
                            <i class="fas fa-random me-1"></i> Embaralhar Ordem das Questões
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Botão Iniciar -->
            <div class="text-center pt-3">
                <button id="btn-iniciar-simulado" class="btn btn-primary btn-lg px-5 py-3 shadow-sm" disabled>
                     <span id="btn-iniciar-text"><i class="fas fa-play me-2"></i> Iniciar Simulado Agora</span>
                     <span id="loading-spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                     <span id="loading-text" style="display: none;"> Carregando...</span>
                </button>
                <!-- Mensagem de erro -->
                <div id="error-message" class="alert alert-danger mt-3" role="alert" style="display: none;"></div>
            </div>
        </div>

        <!-- Tela do Simulado (Jogo) -->
        <div id="tela-simulado" class="page-container" style="display: none;">
            
            <!-- Cabeçalho Fixo -->
            <div class="questao-header sticky-top shadow-sm">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-center w-100">
                    <div class="mb-2 mb-md-0">
                        <div class="questao-counter">Questão <span id="numero-questao-atual">1</span> de <span id="total-questoes">0</span></div>
                        <span id="materia-atual" class="materia-badge-small">Carregando...</span>
                    </div>
                    <div class="timer-container" id="timer-container">
                        <i class="far fa-clock me-2"></i>
                        <span id="timer-display" class="fw-bold">00:00</span>
                    </div>
                </div>
                <!-- Barra de Progresso -->
                <div class="progress mt-3">
                    <div id="progresso-bar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuamax="100"></div>
                </div>
            </div>

            <!-- Área da Questão -->
            <div id="tela-questao" class="mt-4">
                <div id="questao-enunciado" class="mb-4 fs-5 p-4 rounded shadow-sm bg-white">
                     <div class="text-center p-5">
                         <div class="loading-spinner mx-auto"></div>
                    </div>
                </div>

                <!-- Container das Alternativas -->
                <div id="alternativas-container" class="d-grid gap-2">
                     <!-- Alternativas serão carregadas via JavaScript -->
                </div>
            </div>

            <!-- Box de Feedback (inicialmente oculto) -->
            <div id="feedback-container" class="feedback-box mt-4" style="display: none;">
                <div id="feedback-titulo-container">
                    <h5 id="feedback-titulo"></h5>
                </div>
                <ul class="nav nav-tabs" id="feedback-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="nav-justificativa-tab" data-bs-toggle="tab" data-bs-target="#nav-justificativa" type="button" role="tab" aria-controls="nav-justificativa" aria-selected="true">Justificativa</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="nav-dica-tab" data-bs-toggle="tab" data-bs-target="#nav-dica" type="button" role="tab" aria-controls="nav-dica" aria-selected="false">Dica</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="nav-formula-tab" data-bs-toggle="tab" data-bs-target="#nav-formula" type="button" role="tab" aria-controls="nav-formula" aria-selected="false">Fórmula</button>
                    </li>
                </ul>
                <div class="tab-content" id="nav-tabContent">
                  <div class="tab-pane fade show active" id="nav-justificativa" role="tabpanel" aria-labelledby="nav-justificativa-tab">
                      <p id="feedback-justificativa-content" class="justificativa p-3"></p>
                  </div>
                  <div class="tab-pane fade" id="nav-dica" role="tabpanel" aria-labelledby="nav-dica-tab">
                      <div class="dica-box m-3">
                          <p id="texto-dica" class="mb-0"></p>
                      </div>
                  </div>
                  <div class="tab-pane fade" id="nav-formula" role="tabpanel" aria-labelledby="nav-formula-tab">
                      <div class="formula-box m-3">
                          <p id="texto-formula" class="mb-0 font-monospace"></p>
                      </div>
                  </div>
                </div>
            </div>

            <!-- Botões de Navegação -->
            <div class="navigation-buttons d-flex justify-content-between align-items-center mt-4 border-top pt-4">
                 <button id="btn-voltar" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-arrow-left me-2"></i>Anterior
                </button>
                <button id="btn-finalizar-simulado" class="btn btn-outline-danger">
                    <i class="fas fa-stop-circle me-1"></i> Finalizar
                </button>
                <button id="btn-proxima" class="btn btn-primary btn-lg shadow-sm">
                    <span id="btn-proxima-text">Próxima</span> <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado (Bootstrap) -->
    <div class="modal fade" id="modal-resultado" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalResultadoLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fs-4" id="modalResultadoLabel">
                        <i class="fas fa-trophy text-warning me-2"></i> Resultado do Simulado
                    </h5>
                    <button type="button" class="btn-close" data-bs-toggle="modal" data-bs-target="#modal-resultado" aria-label="Close" id="btn-fechar-modal-resultado"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Resumo Geral -->
                    <div class="row text-center mb-4 g-3">
                        <div class="col-md-3 col-6"> 
                            <div class="stats-card p-3">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i> 
                                <h3 id="modal-total-acertos" class="display-6 fw-bold">0</h3> 
                                <p class="text-muted mb-0 small text-uppercase">Acertos</p> 
                            </div> 
                        </div>
                        <div class="col-md-3 col-6"> 
                            <div class="stats-card p-3">
                                <i class="fas fa-times-circle fa-2x text-danger mb-2"></i> 
                                <h3 id="modal-total-erros" class="display-6 fw-bold">0</h3> 
                                <p class="text-muted mb-0 small text-uppercase">Erros</p> 
                            </div> 
                        </div>
                        <div class="col-md-3 col-6"> 
                            <div class="stats-card p-3">
                                <i class="fas fa-percentage fa-2x text-primary mb-2"></i> 
                                <h3 id="modal-percentual-acerto" class="display-6 fw-bold">0%</h3> 
                                <p class="text-muted mb-0 small text-uppercase">Desempenho</p> 
                            </div> 
                        </div>
                        <div class="col-md-3 col-6"> 
                            <div class="stats-card p-3">
                                <i class="far fa-clock fa-2x text-info mb-2"></i> 
                                <h3 id="modal-tempo-total" class="display-6 fw-bold">0 min</h3> 
                                <p class="text-muted mb-0 small text-uppercase">Tempo Gasto</p> 
                            </div> 
                        </div>
                    </div>

                    <div class="row">
                        <!-- Gráfico de Desempenho -->
                        <div class="col-lg-7 mb-4 mb-lg-0">
                            <h5><i class="fas fa-chart-bar me-2"></i>Desempenho por Matéria</h5>
                            <div class="performance-chart" style="height: 350px;">
                                <canvas id="grafico-desempenho-modal"></canvas>
                                <div id="grafico-placeholder" class="chart-placeholder" style="display: none;"> 
                                    <i class="fas fa-info-circle fa-2x mb-2 text-muted"></i> 
                                    <p>Nenhuma questão respondida para gerar o gráfico.</p> 
                                </div>
                            </div>
                        </div>
                        <!-- Recomendações -->
                        <div class="col-lg-5">
                            <h5><i class="fas fa-lightbulb me-2"></i>Plano de Estudo Sugerido</h5>
                            <div id="lista-recomendacoes" style="max-height: 350px; overflow-y: auto;">
                                <div class="recomendation-item">
                                    <i class="fas fa-book text-primary me-2"></i>
                                    <span>Calculando recomendações...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                     <!-- Botão para revisar questões -->
                    <div class="text-center mt-4 border-top pt-3">
                         <button id="btn-revisar-questoes" class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#revisao-questoes-container" aria-expanded="false" aria-controls="revisao-questoes-container">
                             <i class="fas fa-search me-1"></i> Revisar Gabarito Detalhado <i class="fas fa-chevron-down ms-1 small"></i>
                         </button>
                    </div>
                    <!-- Área Colapsável para Revisão -->
                     <div class="collapse mt-3" id="revisao-questoes-container">
                        <div class="card card-body bg-light border-light">
                            <h5 class="mb-3"><i class="fas fa-list-ol me-2"></i>Revisão Detalhada</h5>
                            <div id="revisao-questoes-content" style="max-height: 400px; overflow-y: auto;">
                                <p class="text-muted">Carregando revisão...</p>
                            </div>
                         </div>
                    </div>
                </div>
                <div class="modal-footer bg-light justify-content-center flex-wrap">
                    <a href="/dashboard" class="btn btn-outline-primary m-1"> <i class="fas fa-chart-line"></i> Ver Dashboard </a>
                    <button id="btn-novo-simulado" class="btn btn-primary m-1" data-bs-dismiss="modal"> <i class="fas fa-redo"></i> Fazer Novo Simulado </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Elementos de Celebração -->
    <div id="celebration" class="celebration"></div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lógica do Simulado (V4.1 - Correção ReferenceError) -->
    <script>
        // --- Variáveis Globais de Estado ---
        let simuladoId = null;
        let questoesCache = []; // Array [questaoObj, ...]
        let questaoAtualIndex = 0;
        let totalQuestoes = 0;
        let respostasUsuario = {}; // { index: { alternativa: 'A', tempo: 15.5, feedbackData: {...} } }
        let tempoRestanteSeg = 0;
        let timerInterval = null;
        let tempoInicioQuestao = null; // Timestamp (ms) de início da questão
        let resultadoModal = null; // Instância do Modal Bootstrap
        let graficoModalInstance = null;
        let relatorioFinalCache = null; // Guarda o relatório para revisão

        // --- Cache de Elementos DOM ---
        let DOMElements = {}; 

        // --- Logger ---
        function log(level, message, data = null) {
            const prefix = `[SimuladoJS ${level.toUpperCase()}]`;
            if (data !== null) {
                console[level](prefix, message, data);
            } else {
                console[level](prefix, message);
            }
        }

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', function() {
            // ** CORREÇÃO V4.1: Preencher o cache de DOM AQUI **
            DOMElements = {
                telaConfig: document.getElementById('tela-configuracao'),
                telaSimulado: document.getElementById('tela-simulado'),
                btnIniciar: document.getElementById('btn-iniciar-simulado'),
                btnIniciarText: document.getElementById('btn-iniciar-text'),
                loadingSpinner: document.getElementById('loading-spinner'),
                loadingText: document.getElementById('loading-text'),
                errorMessage: document.getElementById('error-message'),
                listaMaterias: document.getElementById('lista-materias'),
                questaoEnunciado: document.getElementById('questao-enunciado'),
                alternativasContainer: document.getElementById('alternativas-container'),
                feedbackContainer: document.getElementById('feedback-container'),
                feedbackTitulo: document.getElementById('feedback-titulo'),
                feedbackJustificativa: document.getElementById('feedback-justificativa-content'), // CORRIGIDO
                dicaContainer: document.getElementById('dica-container'),
                textoDica: document.getElementById('texto-dica'),
                navDicaTab: document.getElementById('nav-dica-tab'), // CORRIGIDO
                formulaContainer: document.getElementById('formula-container'),
                textoFormula: document.getElementById('texto-formula'),
                navFormulaTab: document.getElementById('nav-formula-tab'), // CORRIGIDO
                numeroQuestaoAtual: document.getElementById('numero-questao-atual'),
                totalQuestoesEl: document.getElementById('total-questoes'),
                materiaAtual: document.getElementById('materia-atual'),
                timerDisplay: document.getElementById('timer-display'),
                progressoBar: document.getElementById('progresso-bar'),
                modalResultado: document.getElementById('modal-resultado'),
                btnSelecionarTodas: document.getElementById('selecionar-todas'),
                btnVoltar: document.getElementById('btn-voltar'),
                btnProxima: document.getElementById('btn-proxima'),
                btnProximaText: document.getElementById('btn-proxima-text'),
                btnFinalizar: document.getElementById('btn-finalizar-simulado'),
                btnRevisarQuestoes: document.getElementById('btn-revisar-questoes'),
                revisaoContainer: document.getElementById('revisao-questoes-container'),
                revisaoContent: document.getElementById('revisao-questoes-content'),
                graficoPlaceholder: document.getElementById('grafico-placeholder'),
                quantidadeValue: document.getElementById('quantidade-value'),
                tempoValue: document.getElementById('tempo-value'),
                quantidadeRange: document.getElementById('quantidade-questoes'),
                tempoRange: document.getElementById('tempo-simulado'),
                modoAleatorioCheck: document.getElementById('modo-aleatorio'),
                btnNovoSimulado: document.getElementById('btn-novo-simulado'),
                btnFecharModal: document.getElementById('btn-fechar-modal-resultado'),
                themeToggle: document.getElementById('theme-toggle'),
                timerContainer: document.getElementById('timer-container')
            };

            log('info','DOM carregado. Iniciando V4.1...');
            carregarMaterias();
            configurarEventListeners();
            try {
                resultadoModal = new bootstrap.Modal(DOMElements.modalResultado);
                 log('info','Modal Bootstrap OK.');
            } catch (e) { log('error',"Erro ao inicializar o modal do Bootstrap:", e); }

            // Listener para limpar revisão quando modal fecha
            DOMElements.modalResultado.addEventListener('hidden.bs.modal', () => {
                log('debug','Modal fechado. Limpando revisão.');
                const collapseElement = DOMElements.revisaoContainer;
                 const bsCollapseInstance = bootstrap.Collapse.getInstance(collapseElement);
                 if (bsCollapseInstance) { bsCollapseInstance.hide(); }
                DOMElements.revisaoContent.innerHTML = '<p class="text-muted">Carregando revisão...</p>';
                 const icon = DOMElements.btnRevisarQuestoes.querySelector('i.fa-chevron-up, i.fa-chevron-down');
                 if(icon) icon.className = 'fas fa-chevron-down ms-1 small';
                 DOMElements.btnRevisarQuestoes.setAttribute('aria-expanded', 'false');
            });
        });

        // Função para alternar entre tema claro e escuro
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = DOMElements.themeToggle.querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'dark');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'light');
            }
        }

        // Verificar preferência de tema salva
        function checkSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const icon = DOMElements.themeToggle.querySelector('i');
                icon.className = 'fas fa-sun';
            }
        }

        // Função para criar efeito de confete
        function createConfetti() {
            const celebration = document.getElementById('celebration');
            celebration.style.opacity = '1';
            
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = getRandomColor();
                confetti.style.animation = `confetti-fall ${Math.random() * 3 + 2}s linear forwards`;
                document.body.appendChild(confetti);
                
                // Remover confetti após a animação
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
            
            // Esconder o overlay de celebração após 3 segundos
            setTimeout(() => {
                celebration.style.opacity = '0';
            }, 3000);
        }

        function getRandomColor() {
            const colors = ['#4361ee', '#3a0ca3', '#4cc9f0', '#f72585', '#f8961e', '#4895ef'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Função para mostrar conquista
        function showAchievement(title) {
            const achievement = document.createElement('div');
            achievement.className = 'achievement-badge';
            achievement.innerHTML = `<i class="fas fa-trophy me-2"></i> ${title}`;
            
            // Adicionar ao topo da página
            const telaSimulado = document.getElementById('tela-simulado');
            telaSimulado.insertBefore(achievement, telaSimulado.firstChild);
            
            // Remover após 5 segundos
            setTimeout(() => {
                achievement.remove();
            }, 5000);
        }

        async function carregarMaterias() {
             log('info','Carregando matérias da API...');
             DOMElements.btnIniciar.disabled = true;
             DOMElements.listaMaterias.innerHTML = `
                 <div class="col-12 text-center p-5">
                     <div class="spinner-border text-primary" role="status"></div>
                     <p class="text-muted mt-2">Carregando matérias...</p>
                 </div>`;
            try {
                const response = await fetch('/api/materias');
                log('debug','Resposta API /materias:', response.status);
                if (!response.ok) throw new Error(`Erro HTTP! ${response.status} - ${response.statusText}`);
                const data = await response.json();
                log('debug','Dados API /materias:', data);

                DOMElements.listaMaterias.innerHTML = '';

                if (data.error){ throw new Error(data.error); }
                if (!data.materias || data.materias.length === 0) {
                     log('warn','Nenhuma matéria encontrada na API.');
                     DOMElements.listaMaterias.innerHTML = '<p class="text-warning col-12 fw-bold">Nenhuma matéria com questões foi encontrada no banco de dados.</p>';
                     return;
                }

                data.materias.forEach(materia => {
                    const total = data.estatisticas[materia]?.total || 0;
                    const div = document.createElement('div');
                    div.className = 'col';
                    const materiaId = `materia-${materia.replace(/[^a-zA-Z0-9_-]/g, '-')}`;
                    
                    // Criar card de matéria interativo
                    const materiaCard = document.createElement('div');
                    materiaCard.className = `materia-card ${total === 0 ? 'disabled' : ''}`;
                    materiaCard.innerHTML = `
                        <div class="form-check materia-checkbox">
                            <input class="form-check-input materia-checkbox-input" type="checkbox"
                                   value="${materia}" id="${materiaId}" ${total === 0 ? 'disabled' : ''}>
                        </div>
                        <label class="form-check-label w-100" for="${materiaId}">
                            ${materia}
                        </label>
                        <span class="materia-badge">${total}</span>
                    `;
                    
                    // Adicionar evento de clique ao card
                    materiaCard.addEventListener('click', function() {
                        if (total > 0) {
                            const checkbox = this.querySelector('.materia-checkbox-input');
                            checkbox.checked = !checkbox.checked;
                            if (checkbox.checked) {
                                this.classList.add('selected');
                            } else {
                                this.classList.remove('selected');
                            }
                            updateStartButton();
                        }
                    });
                    
                    div.appendChild(materiaCard);
                    DOMElements.listaMaterias.appendChild(div);
                });
                
                updateStartButton();
                 log('info','Matérias carregadas e exibidas.');
            } catch (error) {
                log('error','Erro ao carregar matérias:', error);
                DOMElements.listaMaterias.innerHTML = `<p class="text-danger col-12 fw-bold">Falha: ${error.message}.</p>`;
            }
        }

        function updateStartButton() {
            const materiasCheckboxes = document.querySelectorAll('.materia-checkbox-input:checked');
            DOMElements.btnIniciar.disabled = materiasCheckboxes.length === 0;
        }

        function configurarEventListeners() {
             log('debug','Configurando listeners...');
             
             // Tema
             DOMElements.themeToggle.addEventListener('click', toggleTheme);
             checkSavedTheme();
             
             // Sliders
             DOMElements.quantidadeRange.addEventListener('input', e => { 
                 DOMElements.quantidadeValue.textContent = e.target.value; 
             });
             DOMElements.tempoRange.addEventListener('input', e => { 
                 DOMElements.tempoValue.textContent = e.target.value; 
             });
             
             // Botões principais
             DOMElements.btnIniciar.addEventListener('click', iniciarSimulado);
             DOMElements.btnProxima.addEventListener('click', proximaQuestao);
             DOMElements.btnVoltar.addEventListener('click', questaoAnterior);
             DOMElements.btnFinalizar.addEventListener('click', confirmarFinalizarSimulado);
             
             DOMElements.btnNovoSimulado.addEventListener('click', reiniciarInterface);
             DOMElements.btnFecharModal.addEventListener('click', reiniciarInterface);

             // Selecionar todas as matérias
             DOMElements.btnSelecionarTodas.addEventListener('change', (e) => {
                 log('debug',`Checkbox 'Selecionar Todas' mudou para: ${e.target.checked}`);
                 document.querySelectorAll('.materia-checkbox-input:not(:disabled)').forEach(cb => {
                     cb.checked = e.target.checked;
                     const card = cb.closest('.materia-card');
                     if (e.target.checked) {
                         card.classList.add('selected');
                     } else {
                         card.classList.remove('selected');
                     }
                 });
                 updateStartButton();
             });

             const collapseElement = DOMElements.revisaoContainer;
             if (collapseElement) {
                 collapseElement.addEventListener('show.bs.collapse', () => { 
                     DOMElements.btnRevisarQuestoes.querySelector('i.fa-chevron-down').className = 'fas fa-chevron-up ms-1 small'; 
                 });
                 collapseElement.addEventListener('hide.bs.collapse', () => { 
                     DOMElements.btnRevisarQuestoes.querySelector('i.fa-chevron-up').className = 'fas fa-chevron-down ms-1 small'; 
                 });
                 collapseElement.addEventListener('shown.bs.collapse', mostrarRevisaoDetalhada);
             } else {
                 log('error',"Elemento 'revisao-questoes-container' não encontrado.");
             }
             log('debug','Event listeners configurados.');
        }

        // ... (o restante do código JavaScript permanece igual, apenas com as melhorias visuais aplicadas)

    </script>
</body>
</html>