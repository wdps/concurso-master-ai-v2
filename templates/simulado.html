<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado Inteligente V4.0 - ConcursoMaster AI</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- CSS Customizado V4.0 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-graduation-cap"></i> ConcursoMaster AI 4.0
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"> <a class="nav-link" href="/">Início</a> </li>
                    <li class="nav-item"> <a class="nav-link active" aria-current="page" href="/simulado">Simulado</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="/redacao">Redação</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="/dashboard">Dashboard</a> </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Tela de Configuração -->
        <div id="tela-configuracao" class="page-container"> <!-- Usando classe padrão -->
            <h2 class="text-center mb-4">
                <i class="fas fa-cogs text-primary me-2"></i> Configurar Novo Simulado
            </h2>

            <!-- Seleção de Matérias -->
            <div class="mb-4">
                <h5><i class="fas fa-book me-1"></i> 1. Selecione as Matérias</h5>
                <div id="lista-materias" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-2">
                    <div class="col-12 text-center p-5">
                         <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Carregando matérias...</span>
                        </div>
                        <p class="text-muted mt-2">Carregando matérias disponíveis...</p>
                    </div>
                </div>
                 <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="selecionar-todas">
                    <label class="form-check-label" for="selecionar-todas"> Selecionar Todas / Nenhuma </label>
                </div>
            </div>

            <!-- Configurações (Sliders) -->
            <div class="row mb-4 config-sliders">
                <div class="col-md-6 mb-3 mb-md-0">
                    <h5><i class="fas fa-list-ol me-1"></i> 2. Quantidade</h5>
                    <label for="quantidade-questoes" class="form-label">
                        Total: <span id="quantidade-value" class="fw-bold badge bg-primary">50</span> Questões
                    </label>
                    <input type="range" class="form-range" id="quantidade-questoes" min="5" max="100" value="50" step="5">
                </div>
                <div class="col-md-6">
                    <h5><i class="far fa-clock me-1"></i> 3. Tempo</h5>
                    <label for="tempo-simulado" class="form-label">
                        Limite: <span id="tempo-value" class="fw-bold badge bg-info text-dark">180</span> Minutos
                    </label>
                    <input type="range" class="form-range" id="tempo-simulado" min="15" max="360" value="180" step="15">
                </div>
            </div>

            <!-- Modo Aleatório -->
            <div class="mb-4 form-check form-switch fs-5">
                <input class="form-check-input" type="checkbox" id="modo-aleatorio" checked>
                <label class="form-check-label" for="modo-aleatorio"> <i class="fas fa-random me-1"></i> Embaralhar Questões </label>
            </div>

            <!-- Botão Iniciar -->
            <div class="text-center border-top pt-4 mt-4">
                <button id="btn-iniciar-simulado" class="btn btn-primary btn-lg px-5 shadow-sm" disabled>
                     <span id="btn-iniciar-text"><i class="fas fa-play me-2"></i> Iniciar Simulado</span>
                     <span id="loading-spinner" class="spinner-border spinner-border-sm" style="display: none;"></span>
                     <span id="loading-text" style="display: none;"> Iniciando...</span>
                </button>
                <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>

        <!-- Tela do Simulado (Jogo) -->
        <div id="tela-simulado" class="page-container" style="display: none;"> <!-- Usando classe padrão -->

            <!-- Cabeçalho Fixo -->
            <div class="questao-header sticky-top"> <!-- Classe CSS controla o estilo sticky -->
                <div>
                    <h4 class="mb-0">Questão <span id="numero-questao-atual">1</span> / <span id="total-questoes">0</span></h4>
                    <span id="materia-atual" class="badge bg-secondary">...</span>
                </div>
                <div class="timer d-flex align-items-center">
                    <i class="far fa-clock me-2"></i> <span id="timer-display">00:00</span>
                </div>
            </div>
            <!-- Barra de Progresso -->
            <div class="progress mb-4" style="height: 10px;">
                <div id="progresso-bar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width: 0%"></div>
            </div>

            <!-- Área da Questão -->
            <div id="tela-questao">
                <div id="questao-enunciado" class="mb-4 fs-5 alert alert-light shadow-sm">
                     <div class="text-center p-5"><div class="spinner-border text-primary"></div></div>
                </div>
                <div id="alternativas-container">
                     <div class="text-center p-3 text-muted">Carregando alternativas...</div>
                </div>
            </div>

            <!-- Box de Feedback (Gamificado) -->
            <div id="feedback-container" class="feedback-box mt-4" style="display: none;">
                <h5 id="feedback-titulo" class="d-flex align-items-center"></h5>
                <p id="feedback-justificativa" class="justificativa"></p>
                <div id="dica-container" class="dica-box" style="display: none;">
                     <h6><i class="fas fa-lightbulb text-warning"></i> Dica de Interpretação:</h6>
                    <p id="texto-dica"></p>
                </div>
                 <div id="formula-container" class="dica-box mt-2" style="display: none;">
                    <h6><i class="fas fa-calculator text-info"></i> Fórmula Aplicável:</h6>
                    <p id="texto-formula" class="font-monospace"></p>
                </div>
            </div>

            <!-- Botões de Navegação -->
            <div class="d-flex justify-content-between align-items-center mt-4 border-top pt-4">
                 <button id="btn-voltar" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Voltar Questão
                </button>
                <div> <!-- Agrupa botões da direita -->
                    <button id="btn-finalizar-simulado" class="btn btn-outline-danger me-2">
                        <i class="fas fa-stop me-1"></i> Finalizar
                    </button>
                    <button id="btn-proxima" class="btn btn-success btn-lg shadow-sm" disabled>
                        <span id="btn-proxima-text">Próxima</span> <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Modal de Resultado (Gamificado) -->
    <div class="modal fade" id="modal-resultado" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fs-4" id="modalResultadoLabel">
                        <i class="fas fa-trophy text-warning me-2"></i> Resultado Final do Simulado
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" id="btn-fechar-modal-resultado"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Resumo Geral com Ícones -->
                    <div class="row text-center mb-4 g-3">
                        <div class="col-md-3 col-6"> <div class="stats-card p-3"><i class="fas fa-check-circle fa-2x text-success mb-2"></i> <h3 id="modal-total-acertos" class="fw-bold">0</h3> <p class="text-muted mb-0 small text-uppercase">Acertos</p> </div> </div>
                        <div class="col-md-3 col-6"> <div class="stats-card p-3"><i class="fas fa-times-circle fa-2x text-danger mb-2"></i> <h3 id="modal-total-erros" class="fw-bold">0</h3> <p class="text-muted mb-0 small text-uppercase">Erros</p> </div> </div>
                        <div class="col-md-3 col-6"> <div class="stats-card p-3"><i class="fas fa-percentage fa-2x text-primary mb-2"></i> <h3 id="modal-percentual-acerto" class="fw-bold">0%</h3> <p class="text-muted mb-0 small text-uppercase">Desempenho</p> </div> </div>
                        <div class="col-md-3 col-6"> <div class="stats-card p-3"><i class="far fa-clock fa-2x text-info mb-2"></i> <h3 id="modal-tempo-total" class="fw-bold">0 min</h3> <p class="text-muted mb-0 small text-uppercase">Tempo Gasto</p> </div> </div>
                    </div>

                    <div class="row">
                        <!-- Gráfico de Desempenho -->
                        <div class="col-lg-7 mb-4 mb-lg-0">
                            <h5><i class="fas fa-chart-bar me-2"></i>Desempenho por Matéria</h5>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="grafico-desempenho-modal"></canvas>
                                <div id="grafico-placeholder" class="chart-placeholder" style="display: none;"> <i class="fas fa-info-circle fa-2x mb-2 text-muted"></i> <p>Nenhuma questão respondida.</p> </div>
                            </div>
                        </div>
                        <!-- Recomendações -->
                        <div class="col-lg-5">
                            <h5><i class="fas fa-lightbulb me-2"></i>Plano de Estudo Sugerido</h5>
                            <ul id="lista-recomendacoes" class="list-group list-group-flush" style="max-height: 350px; overflow-y: auto;">
                                <li class="list-group-item border-0 text-muted">Calculando...</li>
                            </ul>
                        </div>
                    </div>
                    <!-- Revisão Detalhada (Collapse) -->
                    <div class="text-center mt-4 border-top pt-3">
                         <button id="btn-revisar-questoes" class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#revisao-questoes-container" aria-expanded="false">
                             <i class="fas fa-search me-1"></i> Revisar Gabarito Detalhado <i class="fas fa-chevron-down ms-1 small"></i>
                         </button>
                    </div>
                     <div class="collapse mt-3" id="revisao-questoes-container">
                        <div class="card card-body bg-light border-light">
                            <h5 class="mb-3"><i class="fas fa-list-ol me-2"></i>Revisão Detalhada</h5>
                            <div id="revisao-questoes-content" style="max-height: 400px; overflow-y: auto;">
                                <p class="text-muted">Carregando...</p>
                            </div>
                         </div>
                    </div>
                </div>
                <div class="modal-footer bg-light justify-content-center flex-wrap">
                    <a href="/dashboard" class="btn btn-outline-primary m-1"> <i class="fas fa-chart-line"></i> Ver Dashboard </a>
                    <button id="btn-novo-simulado" class="btn btn-primary m-1" data-bs-dismiss="modal"> <i class="fas fa-redo"></i> Fazer Novo Simulado </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Lógica do Simulado (V4.0 - UI Profissional + Funcional) -->
    <script>
        // --- Variáveis Globais ---
        let simuladoId = null;
        let questoesCache = [];
        let questaoAtualIndex = 0;
        let totalQuestoes = 0;
        let respostasUsuario = {}; // { index: { alternativa: 'A', tempo: 15.5, feedbackData: {...} }, ... }
        let tempoRestanteSeg = 0;
        let timerInterval = null;
        let tempoInicioQuestao = null;
        let resultadoModal = null;
        let graficoModalInstance = null;
        let relatorioFinalCache = null;

        // --- Cache de Elementos DOM ---
        const DOMElements = {
            telaConfig: document.getElementById('tela-configuracao'),
            telaSimulado: document.getElementById('tela-simulado'),
            btnIniciar: document.getElementById('btn-iniciar-simulado'),
            btnIniciarText: document.getElementById('btn-iniciar-text'),
            loadingSpinner: document.getElementById('loading-spinner'),
            loadingText: document.getElementById('loading-text'),
            errorMessage: document.getElementById('error-message'),
            listaMaterias: document.getElementById('lista-materias'),
            questaoEnunciado: document.getElementById('questao-enunciado'),
            alternativasContainer: document.getElementById('alternativas-container'),
            feedbackContainer: document.getElementById('feedback-container'),
            feedbackTitulo: document.getElementById('feedback-titulo'),
            feedbackJustificativa: document.getElementById('feedback-justificativa'),
            dicaContainer: document.getElementById('dica-container'),
            textoDica: document.getElementById('texto-dica'),
            formulaContainer: document.getElementById('formula-container'),
            textoFormula: document.getElementById('texto-formula'),
            numeroQuestaoAtual: document.getElementById('numero-questao-atual'),
            totalQuestoesEl: document.getElementById('total-questoes'),
            materiaAtual: document.getElementById('materia-atual'),
            timerDisplay: document.getElementById('timer-display'),
            progressoBar: document.getElementById('progresso-bar'),
            modalResultado: document.getElementById('modal-resultado'),
            btnSelecionarTodas: document.getElementById('selecionar-todas'),
            btnVoltar: document.getElementById('btn-voltar'),
            btnProxima: document.getElementById('btn-proxima'),
            btnProximaText: document.getElementById('btn-proxima-text'),
            btnFinalizar: document.getElementById('btn-finalizar-simulado'),
            btnRevisarQuestoes: document.getElementById('btn-revisar-questoes'),
            revisaoContainer: document.getElementById('revisao-questoes-container'),
            revisaoContent: document.getElementById('revisao-questoes-content'),
            graficoPlaceholder: document.getElementById('grafico-placeholder'),
            quantidadeValue: document.getElementById('quantidade-value'),
            tempoValue: document.getElementById('tempo-value'),
            quantidadeRange: document.getElementById('quantidade-questoes'),
            tempoRange: document.getElementById('tempo-simulado'),
            modoAleatorioCheck: document.getElementById('modo-aleatorio'),
            btnNovoSimulado: document.getElementById('btn-novo-simulado'),
            btnFecharModal: document.getElementById('btn-fechar-modal-resultado')
        };

        // --- Logger ---
        function log(level, message, data = null) {
            const prefix = `[Simulado ${level.toUpperCase()}]`;
            if (data !== null) { console[level](prefix, message, data); }
            else { console[level](prefix, message); }
        }

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            log('info','DOM carregado. Iniciando V4.0...');
            carregarMaterias();
            configurarEventListeners();
            try {
                resultadoModal = new bootstrap.Modal(DOMElements.modalResultado);
                log('info','Modal Bootstrap OK.');
            } catch (e) { log('error',"Erro inicializar Modal:", e); }

            DOMElements.modalResultado.addEventListener('hidden.bs.modal', () => {
                log('debug','Modal fechado.');
                const bsCollapse = bootstrap.Collapse.getInstance(DOMElements.revisaoContainer);
                if (bsCollapse) { bsCollapse.hide(); }
                DOMElements.revisaoContent.innerHTML = '<p class="text-muted">Carregando...</p>';
                const icon = DOMElements.btnRevisarQuestoes.querySelector('i.fa-chevron-up, i.fa-chevron-down');
                if(icon) icon.className = 'fas fa-chevron-down ms-1 small';
                DOMElements.btnRevisarQuestoes.setAttribute('aria-expanded', 'false');
            });
        });

        // --- Carregar Matérias ---
        async function carregarMaterias() {
            log('info','Carregando matérias da API...');
            DOMElements.btnIniciar.disabled = true;
            DOMElements.listaMaterias.innerHTML = `<div class="col-12 text-center p-5"><div class="spinner-border text-secondary"></div><p class="text-muted mt-2">Carregando...</p></div>`;
            try {
                const response = await fetch('/api/materias');
                log('debug','Resposta API /materias:', response.status);
                if (!response.ok) throw new Error(`Erro HTTP ${response.status}`);
                const data = await response.json();
                log('debug','Dados API /materias:', data);
                DOMElements.listaMaterias.innerHTML = ''; // Limpa

                if (data.error) throw new Error(data.error);
                if (!data.materias || data.materias.length === 0) {
                    log('warn','Nenhuma matéria encontrada.');
                    DOMElements.listaMaterias.innerHTML = '<p class="text-warning col-12 fw-bold">Nenhuma matéria com questões encontrada.</p>';
                    return;
                }

                data.materias.forEach(materia => {
                    const total = data.estatisticas[materia]?.total || 0;
                    const div = document.createElement('div'); div.className = 'col';
                    const id = `materia-${materia.replace(/[^a-zA-Z0-9_-]/g, '-')}`;
                    div.innerHTML = `
                        <div class="form-check materia-checkbox">
                            <input class="form-check-input materia-checkbox-input" type="checkbox" value="${materia}" id="${id}" ${total === 0 ? 'disabled' : ''}>
                            <label class="form-check-label w-100" for="${id}"> ${materia} <span class="badge bg-primary float-end">${total}</span> </label>
                        </div>`;
                    DOMElements.listaMaterias.appendChild(div);
                });
                DOMElements.btnIniciar.disabled = false;
                log('info','Matérias carregadas.');
            } catch (error) {
                log('error','Erro ao carregar matérias:', error);
                DOMElements.listaMaterias.innerHTML = `<p class="text-danger col-12 fw-bold">Falha: ${error.message}.</p>`;
            }
        }

        // --- Configurar Eventos ---
        function configurarEventListeners() {
            log('debug','Configurando listeners...');
            DOMElements.quantidadeRange.addEventListener('input', e => { DOMElements.quantidadeValue.textContent = e.target.value; });
            DOMElements.tempoRange.addEventListener('input', e => { DOMElements.tempoValue.textContent = e.target.value; });
            DOMElements.btnIniciar.addEventListener('click', iniciarSimulado);
            DOMElements.btnProxima.addEventListener('click', proximaQuestao);
            DOMElements.btnVoltar.addEventListener('click', questaoAnterior);
            DOMElements.btnFinalizar.addEventListener('click', confirmarFinalizarSimulado);
            DOMElements.btnNovoSimulado.addEventListener('click', reiniciarInterface);
            DOMElements.btnFecharModal.addEventListener('click', reiniciarInterface);
            DOMElements.btnSelecionarTodas.addEventListener('change', (e) => {
                 document.querySelectorAll('.materia-checkbox-input:not(:disabled)').forEach(cb => cb.checked = e.target.checked);
            });
             const collapseRevisao = DOMElements.revisaoContainer;
             if (collapseRevisao) {
                 collapseRevisao.addEventListener('show.bs.collapse', () => { DOMElements.btnRevisarQuestoes.querySelector('i.fa-chevron-down').className = 'fas fa-chevron-up ms-1 small'; });
                 collapseRevisao.addEventListener('hide.bs.collapse', () => { DOMElements.btnRevisarQuestoes.querySelector('i.fa-chevron-up').className = 'fas fa-chevron-down ms-1 small'; });
                 collapseRevisao.addEventListener('shown.bs.collapse', mostrarRevisaoDetalhada);
             }
            log('debug','Listeners configurados.');
        }

        // --- Lógica do Simulado ---
        async function iniciarSimulado() {
            log('info',"[Iniciar] Clicado!");
            const materiasSel = Array.from(document.querySelectorAll('.materia-checkbox-input:checked')).map(cb => cb.value);
            DOMElements.errorMessage.style.display = 'none';
            if (materiasSel.length === 0) { DOMElements.errorMessage.textContent = 'Selecione matérias!'; DOMElements.errorMessage.style.display = 'block'; return; }

            const config = { materias: materiasSel, quantidade_total: parseInt(DOMElements.quantidadeRange.value),
                             tempo_minutos: parseInt(DOMElements.tempoRange.value), aleatorio: DOMElements.modoAleatorioCheck.checked };
            
            // UI Loading
            DOMElements.btnIniciar.disabled = true; DOMElements.btnIniciarText.style.display = 'none';
            DOMElements.loadingSpinner.style.display = 'inline-block'; DOMElements.loadingText.style.display = 'inline';
            DOMElements.btnIniciar.classList.add('loading');
            log('debug',"[Iniciar] Loading UI set.");

            try {
                log('info',"[Iniciar] Enviando config:", config);
                const response = await fetch('/api/simulado/iniciar', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(config) });
                 log('info',`[Iniciar] Resposta API: ${response.status}`);
                 if (!response.ok) { let eB = await response.text(); try {eB=JSON.parse(eB).error}catch(e){} throw new Error(eB || `Erro ${response.status}`); }
                 const data = await response.json(); log('debug',"[Iniciar] Dados resposta:", data);
                if (!data.success) throw new Error(data.error || "Erro API.");
                if (!data.simulado_id || !data.total_questoes || data.total_questoes <= 0 || !data.primeira_questao) throw new Error("Resposta inválida.");

                // Sucesso
                simuladoId = data.simulado_id; totalQuestoes = data.total_questoes; tempoRestanteSeg = data.tempo_limite_seg;
                questoesCache = new Array(totalQuestoes); questoesCache[0] = data.primeira_questao;
                respostasUsuario = {}; questaoAtualIndex = 0; relatorioFinalCache = null;
                log('info',`[Iniciar] Sucesso! ID: ${simuladoId}, Total Q: ${totalQuestoes}`);

                // Transição UI
                DOMElements.telaConfig.style.display = 'none'; DOMElements.telaSimulado.style.display = 'block';
                requestAnimationFrame(() => {
                     const headerH = DOMElements.telaSimulado.querySelector('.questao-header')?.offsetHeight || 80;
                     DOMElements.telaSimulado.style.paddingTop = `${headerH + 10}px`; // Padding dinâmico
                     log('debug',`[Iniciar] Padding ajustado para ${headerH + 10}px`);
                });
                iniciarTimer();
                carregarQuestao(0);

            } catch (error) {
                log('error','[Iniciar] Erro:', error);
                DOMElements.errorMessage.textContent = `Erro: ${error.message}`; DOMElements.errorMessage.style.display = 'block';
                // Restaura botão
                DOMElements.btnIniciar.disabled = false; DOMElements.btnIniciarText.style.display = 'inline';
                DOMElements.loadingSpinner.style.display = 'none'; DOMElements.loadingText.style.display = 'none';
                DOMElements.btnIniciar.classList.remove('loading');
            }
        }

        async function carregarQuestao(index) {
            if (index < 0 || index >= totalQuestoes || !simuladoId) { log('error',`[CarregarQ] Inválido: idx=${index}, id=${simuladoId}`); return; }
            log('info',`[CarregarQ] Carregando Q ${index}`);
            questaoAtualIndex = index; tempoInicioQuestao = Date.now();

            // Reset UI
            DOMElements.feedbackContainer.style.display = 'none';
            DOMElements.alternativasContainer.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></div>';
            DOMElements.btnProxima.disabled = true; DOMElements.btnVoltar.disabled = (index === 0);

            // Update UI
            DOMElements.numeroQuestaoAtual.textContent = index + 1; DOMElements.totalQuestoesEl.textContent = totalQuestoes;
            const progresso = ((index + 1) / totalQuestoes) * 100;
            DOMElements.progressoBar.style.width = `${progresso}%`; DOMElements.progressoBar.setAttribute('aria-valuenow', progresso);
            if (index === totalQuestoes - 1) { DOMElements.btnProximaText.textContent = 'Finalizar'; DOMElements.btnProxima.querySelector('i').className = 'fas fa-check-circle ms-2'; }
            else { DOMElements.btnProximaText.textContent = 'Próxima'; DOMElements.btnProxima.querySelector('i').className = 'fas fa-arrow-right ms-2'; }

            // Fetch (cache or API)
            let questao;
            if (questoesCache[index]) {
                log('debug',`[CarregarQ] Q ${index} do cache.`); questao = questoesCache[index]; renderizarQuestao(questao);
            } else {
                DOMElements.questaoEnunciado.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';
                try {
                    log('info',`[CarregarQ] Buscando Q ${index} da API...`);
                    const response = await fetch(`/api/simulado/${simuladoId}/questao/${index}`);
                    log('debug',`[CarregarQ] Resposta API Q ${index}: ${response.status}`);
                    if (!response.ok) throw new Error(`Erro HTTP ${response.status}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error); if (!data.questao) throw new Error("API não retornou questão.");
                    log('debug',`[CarregarQ] Q ${index} recebida:`, data.questao);
                    questoesCache[index] = data.questao; renderizarQuestao(data.questao);
                } catch (error) {
                    log('error','[CarregarQ] Erro API:', error);
                    DOMElements.questaoEnunciado.innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
                    DOMElements.alternativasContainer.innerHTML = ''; DOMElements.btnFinalizar.disabled = false;
                }
            }
        }

        function renderizarQuestao(questao) {
             log('info',`[RenderizarQ] Renderizando Q ID ${questao?.id}`);
            if (!questao?.enunciado || !questao?.alternativas) {
                 log('error',"[RenderizarQ] Dados inválidos:", questao);
                 DOMElements.questaoEnunciado.innerHTML = '<div class="alert alert-warning">Erro dados inválidos.</div>'; DOMElements.alternativasContainer.innerHTML = ''; return;
            }
            DOMElements.materiaAtual.textContent = questao.materia || 'N/A';
            const enunciadoP = document.createElement('p'); enunciadoP.innerHTML = questao.enunciado.replace(/\n/g, '<br>');
            DOMElements.questaoEnunciado.innerHTML = ''; DOMElements.questaoEnunciado.className = 'mb-4 fs-5 alert alert-light shadow-sm'; DOMElements.questaoEnunciado.appendChild(enunciadoP);
            DOMElements.alternativasContainer.innerHTML = '';

            const letrasOrdenadas = Object.keys(questao.alternativas).sort();
            letrasOrdenadas.forEach(letra => {
                const texto = questao.alternativas[letra];
                if (texto && String(texto).trim() !== '') {
                    const button = document.createElement('button'); button.type = 'button';
                    button.className = 'alternativa text-start'; button.dataset.alternativa = letra;
                    const strong = document.createElement('strong'); strong.className = 'me-2'; strong.textContent = `${letra})`;
                    button.appendChild(strong); button.appendChild(document.createTextNode(` ${texto}`));
                    // Verifica se já foi respondida (navegando de volta)
                    if (respostasUsuario[questaoAtualIndex] && respostasUsuario[questaoAtualIndex].alternativa === letra) {
                        button.classList.add('selecionada');
                    }
                    button.onclick = () => selecionarAlternativa(letra, button);
                    DOMElements.alternativasContainer.appendChild(button);
                }
            });
            // Se a questão já foi respondida anteriormente (ao usar "Voltar"), mostra o feedback
            if (respostasUsuario[questaoAtualIndex]) {
                 log('debug',`[RenderizarQ] Re-exibindo feedback para Q ${questaoAtualIndex}`);
                 mostrarFeedback(respostasUsuario[questaoAtualIndex].alternativa, DOMElements.alternativasContainer.querySelector(`.alternativa[data-alternativa="${respostasUsuario[questaoAtualIndex].alternativa}"]`), respostasUsuario[questaoAtualIndex].feedbackData, true);
                 DOMElements.btnProxima.disabled = false; // Habilita Próxima ao voltar
                 DOMElements.alternativasContainer.querySelectorAll('.alternativa').forEach(btn => btn.disabled = true); // Desabilita alternativas
            }
             log('debug',`[RenderizarQ] Q ID ${questao.id} renderizada.`);
        }

        async function selecionarAlternativa(letra, botaoSelecionado) {
            const tempoFimQuestao = Date.now();
            const tempoGastoSeg = Math.max(0, Math.round((tempoFimQuestao - tempoInicioQuestao) / 1000));
            log('info',`[SelecionarAlt] Selecionada: ${letra}, Tempo: ${tempoGastoSeg}s`);

            const alternativas = DOMElements.alternativasContainer.querySelectorAll('.alternativa');
            alternativas.forEach(btn => { btn.disabled = true; });
            botaoSelecionado.classList.add('selecionada');

            DOMElements.feedbackContainer.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Verificando...</div>';
            DOMElements.feedbackContainer.style.display = 'block';

            try {
                 log('debug',`[SelecionarAlt] Enviando POST /responder`);
                 const response = await fetch(`/api/simulado/${simuladoId}/responder`, {
                     method: 'POST', headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({ questao_index: questaoAtualIndex, alternativa: letra, tempo_gasto: tempoGastoSeg })
                 });
                 const data = await response.json(); log('debug',"[SelecionarAlt] Resposta API:", data);
                 if (!response.ok || !data.success) throw new Error(data.error || `Erro HTTP ${response.status}`);

                 // Guarda a resposta E o feedback recebido
                 respostasUsuario[questaoAtualIndex] = {
                     alternativa: letra,
                     tempo: tempoGastoSeg,
                     feedbackData: data // Guarda todo o objeto de feedback
                 };
                 log('info',"[SelecionarAlt] Resposta registrada.");

                 mostrarFeedback(letra, botaoSelecionado, data, false); // false = não está navegando de volta
                 DOMElements.btnProxima.disabled = false;

            } catch (error) {
                 log('error',"[SelecionarAlt] Erro:", error);
                 DOMElements.feedbackContainer.innerHTML = `<div class="alert alert-danger mb-0">Erro: ${error.message}. Clique em Próxima.</div>`;
                 DOMElements.feedbackContainer.style.display = 'block';
                 DOMElements.btnProxima.disabled = false;
            }
        }

        function mostrarFeedback(letraEscolhida, botaoSelecionado, feedbackData, isNavegandoVolta) {
            log('info',`[MostrarFeedback] Exibindo para ${letraEscolhida}. Acertou: ${feedbackData?.acertou}. Voltando: ${isNavegandoVolta}`);
            const { acertou, resposta_correta, justificativa, dica, formula } = feedbackData;

            if (typeof acertou !== 'boolean' || !resposta_correta) { log('error',"[MostrarFeedback] Dados inválidos:", feedbackData); DOMElements.feedbackContainer.innerHTML = '<div class="alert alert-warning">Erro feedback.</div>'; return; }

            const tituloEl = DOMElements.feedbackTitulo;
            const justEl = DOMElements.feedbackJustificativa;

            // Colore alternativas
            DOMElements.alternativasContainer.querySelectorAll('.alternativa').forEach(btn => {
                const altLetra = btn.dataset.alternativa;
                btn.classList.remove('correta', 'errada-escolhida'); // Limpa
                if (altLetra === resposta_correta) btn.classList.add('correta');
                if (altLetra === letraEscolhida && !acertou) btn.classList.add('errada-escolhida');
                if (altLetra === letraEscolhida) btn.classList.add('selecionada');
            });

            // Configura box de feedback
            if (acertou) { feedbackContainerEl.className = 'feedback-box correto'; tituloEl.innerHTML = '<i class="fas fa-check-circle me-2"></i>Resposta Correta!'; }
            else { feedbackContainerEl.className = 'feedback-box incorreto'; tituloEl.innerHTML = `<i class="fas fa-times-circle me-2"></i>Incorreta! (Correta: ${resposta_correta})`; }

            // Mostra justif, dica, formula
            justEl.textContent = justificativa || (acertou ? 'Parabéns!' : `A alternativa correta era a ${resposta_correta}.`);
            
            if (dica) { DOMElements.textoDica.textContent = dica; DOMElements.dicaContainer.style.display = 'block'; }
            else { DOMElements.dicaContainer.style.display = 'none'; }
            if (formula) { DOMElements.textoFormula.textContent = formula; DOMElements.formulaContainer.style.display = 'block'; }
            else { DOMElements.formulaContainer.style.display = 'none'; }

            feedbackContainerEl.style.display = 'block';
            if (!isNavegandoVolta) { // Só rola se não estiver navegando de volta
                feedbackContainerEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        function questaoAnterior() {
            log('info',"[questaoAnterior] Clicado.");
            if (questaoAtualIndex > 0) {
                 carregarQuestao(questaoAtualIndex - 1);
            }
        }

        function proximaQuestao() {
             log('info',"[proximaQuestao] Clicado.");
             errorMessage.style.display = 'none';
            if (questaoAtualIndex === totalQuestoes - 1) { finalizarSimulado(); }
            else { carregarQuestao(questaoAtualIndex + 1); }
        }

        function confirmarFinalizarSimulado() {
            log('info',"[confirmarFinalizar] Clicado.");
            const respCount = Object.keys(respostasUsuario).length; const naoRespCount = totalQuestoes - respCount;
            let msg = "Finalizar simulado agora?";
            if (naoRespCount > 0) msg += `\n${naoRespCount} questão(ões) não respondida(s) será(ão) considerada(s) erro.`;
            if (confirm(msg)) { log('info',"[confirmarFinalizar] Confirmado."); finalizarSimulado(); }
            else { log('info',"[confirmarFinalizar] Cancelado."); }
        }

        async function finalizarSimulado() {
            clearInterval(timerInterval);
            log('info',"[finalizarSimulado] Iniciando...");
            telaSimulado.innerHTML = `<div class="text-center py-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div><h3 class="text-muted mt-3">Calculando resultado...</h3></div>`;
            try {
                log('info',`[finalizarSimulado] POST /api/simulado/${simuladoId}/finalizar`);
                const response = await fetch(`/api/simulado/${simuladoId}/finalizar`, { method: 'POST' });
                 log('info',"[finalizarSimulado] Resposta API:", response.status); if (!response.ok) throw new Error(`Erro HTTP ${response.status}`);
                const data = await response.json(); log('debug',"[finalizarSimulado] Dados:", data);
                if (data.success && data.relatorio) { relatorioFinalCache = data.relatorio; mostrarResultado(data.relatorio); }
                else { throw new Error(data.error || 'Erro desconhecido.'); }
            } catch (error) {
                log('error','[finalizarSimulado] Erro:', error);
                telaSimulado.innerHTML = `<div class="alert alert-danger text-center"><h4>Erro ao Finalizar</h4><p>${error.message}</p><button onclick="reiniciarInterface()" class="btn btn-primary mt-2"><i class="fas fa-redo me-1"></i> Voltar</button></div>`;
                 if (resultadoModal) { resultadoModal.hide(); }
            }
        }

        // --- Timer ---
        function iniciarTimer() {
            clearInterval(timerInterval); log('info',`[iniciarTimer] Iniciando com ${tempoRestanteSeg} segundos.`);
            function atualizarDisplay() {
                 const min = Math.floor(tempoRestanteSeg / 60); const seg = tempoRestanteSeg % 60;
                 DOMElements.timerDisplay.textContent = `${String(min).padStart(2,'0')}:${String(seg).padStart(2,'0')}`;
                 if (tempoRestanteSeg <= 60 && !DOMElements.timerDisplay.classList.contains('text-danger')) DOMElements.timerDisplay.classList.add('text-danger');
                 else if (tempoRestanteSeg > 60 && DOMElements.timerDisplay.classList.contains('text-danger')) DOMElements.timerDisplay.classList.remove('text-danger');
            }
            atualizarDisplay();
            timerInterval = setInterval(() => {
                if (tempoRestanteSeg > 0) { tempoRestanteSeg--; atualizarDisplay(); }
                if (tempoRestanteSeg <= 0) {
                    clearInterval(timerInterval); log('warn',"[iniciarTimer] Tempo acabou!");
                    console.warn("Tempo esgotado!"); // Log
                    DOMElements.feedbackContainer.innerHTML = `<div class="alert alert-warning text-center fw-bold">Tempo esgotado! Finalizando...</div>`;
                    DOMElements.feedbackContainer.style.display = 'block';
                    setTimeout(finalizarSimulado, 1500);
                }
            }, 1000);
        }

        // --- Resultado, Revisão e Reinício ---
        function mostrarResultado(relatorio) {
            log('info',"[mostrarResultado] Exibindo modal:", relatorio);
            telaSimulado.style.display = 'none';
            // KPIs
            document.getElementById('modal-total-acertos').textContent = relatorio.geral?.acertos ?? 0;
            document.getElementById('modal-total-erros').textContent = relatorio.geral?.erros ?? 0;
            document.getElementById('modal-percentual-acerto').textContent = `${relatorio.geral?.percentual_acerto ?? 0}%`;
            document.getElementById('modal-tempo-total').textContent = `${relatorio.geral?.tempo_total_minutos ?? 0} min`;
            renderGraficoModal(relatorio.por_materia); // Gráfico
            const listaRec = DOMElements.listaRecomendacoes; listaRec.innerHTML = ''; // Recomendações
            if (relatorio.recomendacoes?.length > 0) relatorio.recomendacoes.forEach(recHTML => listaRec.insertAdjacentHTML('beforeend', recHTML));
            else listaRec.innerHTML = '<li class="list-group-item border-0 text-muted">Nenhuma recomendação.</li>';
            if(resultadoModal) resultadoModal.show(); else log('error',"[mostrarResultado] Modal não inicializado.");
        }

        function renderGraficoModal(dadosMateria) {
             const canvas = document.getElementById('grafico-desempenho-modal'); const ctx = canvas.getContext('2d');
             graficoPlaceholder.style.display = 'none';
            if (graficoModalInstance) graficoModalInstance.destroy();
            const materias = Object.keys(dadosMateria); const percentuais = materias.map(m => dadosMateria[m]?.percentual ?? 0);
             if (materias.length === 0) { log('warn',"[renderGraficoModal] Sem dados."); graficoPlaceholder.style.display = 'block'; canvas.style.display = 'none'; return; }
             canvas.style.display = 'block'; log('debug',"[renderGraficoModal] Renderizando:", dadosMateria);
            graficoModalInstance = new Chart(ctx, {
                type: 'bar', data: { labels: materias, datasets: [{ label: 'Acerto (%)', data: percentuais, backgroundColor: 'rgba(13, 110, 253, 0.7)', borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + "%" } }, x: { ticks: { autoSkip: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${c.formattedValue}%` } } } }
            });
        }

        function mostrarRevisaoDetalhada() {
             log('info',"[mostrarRevisaoDetalhada] Carregando...");
             revisaoQuestoesContent.innerHTML = '<p class="text-muted">Carregando...</p>'; // Spinner
             if (!relatorioFinalCache?.questoes_com_detalhes) { log('warn',"[mostrarRevisaoDetalhada] Dados não encontrados."); revisaoQuestoesContent.innerHTML = '<p class="text-danger">Erro.</p>'; return; }
             revisaoQuestoesContent.innerHTML = ''; // Limpa
             if(relatorioFinalCache.questoes_com_detalhes.length === 0) { revisaoQuestoesContent.innerHTML = '<p class="text-muted">Nenhuma questão.</p>'; return; }
             log('debug',`[mostrarRevisaoDetalhada] Renderizando ${relatorioFinalCache.questoes_com_detalhes.length} itens.`);

             relatorioFinalCache.questoes_com_detalhes.forEach(q => {
                 const divQuestao = document.createElement('div'); divQuestao.className = 'revisao-item';
                 const icon = q.acertou === true ? 'fa-check-circle text-success' : q.acertou === false ? 'fa-times-circle text-danger' : 'fa-minus-circle text-muted';
                 divQuestao.innerHTML = `
                    <div class="revisao-header">
                        <span class="revisao-numero">Q.${q.numero} (${q.materia || 'N/A'})</span>
                        <span><i class="fas ${icon} ms-2"></i></span>
                    </div>
                    <div class="revisao-enunciado">${q.enunciado ? q.enunciado.replace(/\n/g, '<br>') : '[Ausente]'}</div>
                    <div class="revisao-alternativas-container mt-2"></div>
                    ${q.justificativa ? `<div class="revisao-justificativa"><strong>Justificativa:</strong> ${q.justificativa}</div>` : ''}
                 `;
                 const altsDiv = divQuestao.querySelector('.revisao-alternativas-container');
                 const alts = q.alternativas || {};
                 Object.keys(alts).sort().forEach(letra => {
                     const altSpan = document.createElement('span'); altSpan.className = 'revisao-alternativa d-block';
                     altSpan.innerHTML = `<strong>${letra})</strong> `; altSpan.appendChild(document.createTextNode(alts[letra] || '[Ausente]'));
                     if (letra === q.resposta_correta) altSpan.classList.add('bg-success-light', 'text-success-dark', 'fw-bold');
                     if (letra === q.resposta_usuario && q.acertou === false) altSpan.classList.add('bg-danger-light', 'text-danger-dark');
                     if (letra === q.resposta_usuario && q.acertou === true) altSpan.style.border = '2px solid #198754';
                     altsDiv.appendChild(altSpan);
                 });
                 revisaoQuestoesContent.appendChild(divQuestao);
             });
         }


        function reiniciarInterface() {
            log('info',"[reiniciarInterface] Reiniciando...");
            // Forma mais segura: Recarregar a página para garantir estado limpo
            window.location.reload();
        }

    </script>
</body>
</html>
